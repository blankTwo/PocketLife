# 📊 电子宠物小程序 - 数据库架构设计文档

> 面向未来的可扩展数据库架构设计

---

## 📋 文档信息

- **项目名称**：口袋宠物小程序
- **文档版本**：v2.0
- **创建日期**：2024-01-14
- **最后更新**：2024-01-14
- **设计目标**：支持多宠物、商城、成就等扩展功能

---

## 🎯 设计原则

### 1. 职责单一
每个表只负责一类数据，避免字段冗余和职责混乱

### 2. 关系清晰
用户 → 宠物 → 物品，层次分明，易于理解和维护

### 3. 易于扩展
新增功能不影响现有表结构，支持平滑升级

### 4. 性能优先
合理使用索引和数据冗余，优化常用查询

### 5. 数据安全
完整的交易流水记录，支持数据追溯和对账

---

## 🗂️ 数据库架构总览

### 表关系图

```
users (用户表) - 用户基础信息和货币
  ├─ 1:N → pets (宠物表) - 宠物状态数据
  ├─ 1:N → user_items (用户背包) - 拥有的物品
  ├─ 1:N → transactions (交易记录) - 货币和物品流水
  ├─ 1:N → user_achievements (用户成就) - 成就进度
  └─ 1:N → daily_tasks (每日任务) - 任务进度

items (物品模板) - 物品定义（静态数据）
  └─ 1:N → user_items

achievements (成就模板) - 成就定义（静态数据）
  └─ 1:N → user_achievements
```

### 版本演进

- **V1.0（当前）**：单宠物系统，pets 表独立存在
- **V1.5（规划）**：多宠物系统，新增 users 表，改造 pets 表
- **V2.0（规划）**：物品与商城，新增 items、user_items、transactions 表
- **V2.5+（可选）**：成就与任务，新增 achievements、user_achievements、daily_tasks 表

---
## 📊 数据库表详细设计

---

## 1️⃣ users 表（用户基础信息）

### 用途
存储用户级别的数据和配置，包括货币、等级、槽位解锁状态等

### 字段定义

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| _id | string | 是 | 自动生成 | 数据库自动生成的唯一 ID |
| openid | string | 是 | - | 微信用户唯一标识 |
| nickname | string | 否 | null | 用户昵称 |
| avatarUrl | string | 否 | null | 用户头像 URL |
| level | number | 是 | 1 | 用户等级 |
| exp | number | 是 | 0 | 经验值 |
| coins | number | 是 | 100 | 金币（游戏内货币） |
| diamonds | number | 是 | 0 | 钻石（付费货币） |
| activePetId | string | 否 | null | 当前激活的宠物 ID |
| unlockedSlots | array | 是 | [0] | 已解锁的槽位数组 |
| maxSlots | number | 是 | 3 | 最大槽位数 |
| totalPets | number | 是 | 0 | 拥有的宠物总数 |
| totalActions | number | 是 | 0 | 总操作次数 |
| createdAt | number | 是 | Date.now() | 创建时间戳（毫秒） |
| lastLoginAt | number | 是 | Date.now() | 最后登录时间戳（毫秒） |
| version | number | 是 | 0 | 版本号（用于乐观锁） |

### 索引设计

- **唯一索引**：`openid`（确保一个微信用户只有一条记录）

### 初始值示例

```javascript
{
  openid: "oXYZ_user123",
  nickname: null,
  avatarUrl: null,
  level: 1,
  exp: 0,
  coins: 100,
  diamonds: 0,
  activePetId: null,
  unlockedSlots: [0],
  maxSlots: 3,
  totalPets: 0,
  totalActions: 0,
  createdAt: 1704067200000,
  lastLoginAt: 1704067200000,
  version: 0
}
```

### 设计说明

- `activePetId`：冗余字段，避免每次都查询 pets 表
- `unlockedSlots`：数组形式，方便扩展更多槽位
- `totalPets`、`totalActions`：统计字段，避免频繁 count 查询

---
## 2️⃣ pets 表（宠物数据）

### 用途
存储宠物的状态和属性，支持多宠物系统

### 字段定义

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| _id | string | 是 | 自动生成 | 数据库自动生成的唯一 ID |
| openid | string | 是 | - | 所属用户的 openid |
| slotIndex | number | 是 | - | 槽位编号（0-2） |
| petType | string | 是 | - | 宠物种类（cat/dog/rabbit） |
| name | string | 是 | - | 宠物名称（2-6 字符） |
| stage | string | 是 | baby | 进化阶段（baby/adult/master） |
| hunger | number | 是 | 100 | 饥饿值（0-100） |
| mood | number | 是 | 100 | 心情值（0-100） |
| energy | number | 是 | 100 | 精力值（0-100） |
| health | number | 是 | 100 | 健康值（0-100，预留） |
| cleanliness | number | 是 | 100 | 清洁度（0-100，预留） |
| lastUpdate | number | 是 | Date.now() | 上次结算时间戳（毫秒） |
| lastActionAt | number | 是 | 0 | 上次操作时间戳（毫秒） |
| createdAt | number | 是 | Date.now() | 宠物创建时间戳（毫秒） |
| goodStateStartAt | number | 否 | null | 高状态起始时间（用于进化判定） |
| dead | boolean | 是 | false | 是否死亡 |
| deadAt | number | 否 | null | 死亡时间戳（毫秒） |
| totalFeedCount | number | 是 | 0 | 喂食次数 |
| totalPlayCount | number | 是 | 0 | 玩耍次数 |
| totalSleepCount | number | 是 | 0 | 睡觉次数 |
| totalAliveTime | number | 是 | 0 | 存活时长（毫秒） |
| equippedItems | array | 是 | [] | 已装备的物品 ID 数组（预留） |
| skinId | string | 否 | null | 当前皮肤 ID（预留） |
| version | number | 是 | 0 | 版本号（用于乐观锁） |

### 索引设计

- **普通索引**：`openid`（查询用户所有宠物）
- **复合唯一索引**：`(openid, slotIndex)`（防止槽位冲突）
- **普通索引**：`dead`（用于统计）

### 初始值示例

```javascript
{
  openid: "oXYZ_user123",
  slotIndex: 0,
  petType: "cat",
  name: "小花",
  stage: "baby",
  hunger: 100,
  mood: 100,
  energy: 100,
  health: 100,
  cleanliness: 100,
  lastUpdate: 1704067200000,
  lastActionAt: 0,
  createdAt: 1704067200000,
  goodStateStartAt: null,
  dead: false,
  deadAt: null,
  totalFeedCount: 0,
  totalPlayCount: 0,
  totalSleepCount: 0,
  totalAliveTime: 0,
  equippedItems: [],
  skinId: null,
  version: 0
}
```

### 设计说明

- `slotIndex`：限制宠物数量，0-2 表示最多 3 只
- `petType`：支持不同种类的宠物，差异化养成体验
- `health`、`cleanliness`：预留字段，为后续功能扩展做准备
- 统计字段：记录宠物的行为数据，用于成就和数据分析

---
## 3️⃣ items 表（物品模板定义）

### 用途
定义游戏中所有物品的模板（静态数据），用于商城和背包系统

### 字段定义

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| _id | string | 是 | 自动生成 | 数据库自动生成的唯一 ID |
| itemId | string | 是 | - | 物品唯一标识（如 food_001） |
| name | string | 是 | - | 物品名称 |
| description | string | 是 | - | 物品描述 |
| category | string | 是 | - | 类别（food/toy/medicine/skin/decoration） |
| subCategory | string | 否 | null | 子类别 |
| effects | object | 是 | {} | 物品效果 {hunger, mood, energy, health} |
| targetPetTypes | array | 否 | null | 适用宠物类型，null = 全部适用 |
| cooldown | number | 是 | 0 | 冷却时间（毫秒） |
| consumable | boolean | 是 | true | 是否消耗品 |
| price | number | 是 | 0 | 金币价格 |
| diamondPrice | number | 是 | 0 | 钻石价格 |
| available | boolean | 是 | true | 是否在商城上架 |
| rarity | string | 是 | common | 稀有度（common/rare/epic/legendary） |
| icon | string | 否 | null | 图标 URL |
| createdAt | number | 是 | Date.now() | 创建时间戳（毫秒） |

### 索引设计

- **唯一索引**：`itemId`（物品唯一标识）
- **普通索引**：`category`（按类别查询）

### 示例数据

```javascript
{
  itemId: "food_001",
  name: "高级猫粮",
  description: "营养丰富的猫粮，能大幅提升饥饿值",
  category: "food",
  subCategory: "premium",
  effects: {
    hunger: 30,
    mood: 10,
    energy: 0,
    health: 5
  },
  targetPetTypes: ["cat"],
  cooldown: 300000,  // 5分钟
  consumable: true,
  price: 50,
  diamondPrice: 0,
  available: true,
  rarity: "rare",
  icon: "https://...",
  createdAt: 1704067200000
}
```

### 设计说明

- 静态数据表，由管理员配置，不由用户直接修改
- `effects` 对象：灵活定义物品效果，支持多种属性加成
- `targetPetTypes`：限制物品适用范围，增加策略性
- `rarity`：稀有度系统，为后续抽卡/活动做准备

---

## 4️⃣ user_items 表（用户背包）

### 用途
存储用户拥有的物品实例和数量

### 字段定义

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| _id | string | 是 | 自动生成 | 数据库自动生成的唯一 ID |
| openid | string | 是 | - | 所属用户的 openid |
| itemId | string | 是 | - | 物品模板 ID（关联 items 表） |
| quantity | number | 是 | 1 | 数量 |
| source | string | 是 | - | 来源（purchase/gift/achievement/daily） |
| acquiredAt | number | 是 | Date.now() | 获取时间戳（毫秒） |
| lastUsedAt | number | 否 | null | 最后使用时间戳（毫秒） |
| expiresAt | number | 否 | null | 过期时间戳（毫秒），null = 永久 |

### 索引设计

- **普通索引**：`openid`（查询用户背包）
- **复合索引**：`(openid, itemId)`（快速查询用户是否拥有某物品）

### 示例数据

```javascript
{
  openid: "oXYZ_user123",
  itemId: "food_001",
  quantity: 5,
  source: "purchase",
  acquiredAt: 1704067200000,
  lastUsedAt: 1704153600000,
  expiresAt: null
}
```

### 设计说明

- 动态数据表，记录用户实际拥有的物品
- `quantity`：支持堆叠，减少数据量
- `source`：记录物品来源，用于数据分析
- `expiresAt`：支持限时物品，增加运营灵活性

---
## 5️⃣ transactions 表（交易记录）

### 用途
记录所有货币和物品的流水，用于对账和数据分析

### 字段定义

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| _id | string | 是 | 自动生成 | 数据库自动生成的唯一 ID |
| openid | string | 是 | - | 用户的 openid |
| type | string | 是 | - | 交易类型（purchase/consume/reward/gift） |
| itemId | string | 否 | null | 物品 ID（如果是物品交易） |
| quantity | number | 是 | 1 | 数量 |
| coinsDelta | number | 是 | 0 | 金币变化（负数 = 支出） |
| diamondsDelta | number | 是 | 0 | 钻石变化（负数 = 支出） |
| coinsAfter | number | 是 | - | 交易后金币余额 |
| diamondsAfter | number | 是 | - | 交易后钻石余额 |
| relatedPetId | string | 否 | null | 关联的宠物 ID（如果有） |
| createdAt | number | 是 | Date.now() | 创建时间戳（毫秒） |

### 索引设计

- **普通索引**：`openid`（查询用户交易记录）
- **普通索引**：`type`（按类型统计）
- **复合索引**：`(openid, createdAt)`（按时间查询用户交易）

### 示例数据

```javascript
{
  openid: "oXYZ_user123",
  type: "purchase",
  itemId: "food_001",
  quantity: 1,
  coinsDelta: -50,
  diamondsDelta: 0,
  coinsAfter: 450,
  diamondsAfter: 20,
  relatedPetId: "pet_001",
  createdAt: 1704153600000
}
```

### 设计说明

- 只增不改的流水表，保证数据完整性
- 记录余额快照（coinsAfter、diamondsAfter），便于对账
- `type` 字段：区分不同交易场景，便于统计分析
- 支持追溯所有货币和物品的来源和去向

---

## 6️⃣ achievements 表（成就定义）

### 用途
定义游戏中的成就系统（静态数据）

### 字段定义

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| _id | string | 是 | 自动生成 | 数据库自动生成的唯一 ID |
| achievementId | string | 是 | - | 成就唯一标识 |
| name | string | 是 | - | 成就名称 |
| description | string | 是 | - | 成就描述 |
| category | string | 是 | - | 类别（pet/action/collection/social） |
| condition | object | 是 | {} | 完成条件 {type, target} |
| rewards | object | 是 | {} | 奖励 {coins, diamonds, items, unlockSlot} |
| rarity | string | 是 | common | 稀有度（common/rare/epic/legendary） |
| icon | string | 否 | null | 图标 URL |
| hidden | boolean | 是 | false | 是否隐藏成就 |

### 索引设计

- **唯一索引**：`achievementId`（成就唯一标识）

### 示例数据

```javascript
{
  achievementId: "first_pet",
  name: "初次相遇",
  description: "获得第一只宠物",
  category: "pet",
  condition: {
    type: "pet_count",
    target: 1
  },
  rewards: {
    coins: 100,
    diamonds: 0,
    items: ["food_001"],
    unlockSlot: null
  },
  rarity: "common",
  icon: "https://...",
  hidden: false
}
```

### 设计说明

- 静态数据表，由管理员配置
- `condition` 对象：灵活定义成就条件
- `rewards` 对象：支持多种奖励类型
- `hidden`：支持隐藏成就，增加探索乐趣

---

## 7️⃣ user_achievements 表（用户成就进度）

### 用途
记录用户的成就完成情况和进度

### 字段定义

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| _id | string | 是 | 自动生成 | 数据库自动生成的唯一 ID |
| openid | string | 是 | - | 用户的 openid |
| achievementId | string | 是 | - | 成就 ID（关联 achievements 表） |
| progress | number | 是 | 0 | 当前进度 |
| target | number | 是 | - | 目标进度 |
| completed | boolean | 是 | false | 是否完成 |
| rewardClaimed | boolean | 是 | false | 是否已领取奖励 |
| startedAt | number | 是 | Date.now() | 开始时间戳（毫秒） |
| completedAt | number | 否 | null | 完成时间戳（毫秒） |
| claimedAt | number | 否 | null | 领取时间戳（毫秒） |

### 索引设计

- **复合索引**：`(openid, achievementId)`（查询用户特定成就）
- **普通索引**：`completed`（统计完成情况）

### 示例数据

```javascript
{
  openid: "oXYZ_user123",
  achievementId: "first_pet",
  progress: 1,
  target: 1,
  completed: true,
  rewardClaimed: true,
  startedAt: 1704067200000,
  completedAt: 1704153600000,
  claimedAt: 1704153700000
}
```

### 设计说明

- 动态数据表，记录用户实际进度
- 完成和领取分离：允许用户稍后领取奖励
- 记录完整时间线：开始、完成、领取

---
## 8️⃣ daily_tasks 表（每日任务）

### 用途
每日刷新的任务系统，提升日活和留存

### 字段定义

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| _id | string | 是 | 自动生成 | 数据库自动生成的唯一 ID |
| openid | string | 是 | - | 用户的 openid |
| taskId | string | 是 | - | 任务 ID |
| name | string | 是 | - | 任务名称 |
| progress | number | 是 | 0 | 当前进度 |
| target | number | 是 | - | 目标进度 |
| completed | boolean | 是 | false | 是否完成 |
| rewards | object | 是 | {} | 奖励 {coins, exp} |
| date | string | 是 | - | 任务日期（YYYY-MM-DD） |
| createdAt | number | 是 | Date.now() | 创建时间戳（毫秒） |
| completedAt | number | 否 | null | 完成时间戳（毫秒） |

### 索引设计

- **复合索引**：`(openid, date)`（查询用户当日任务）

### 示例数据

```javascript
{
  openid: "oXYZ_user123",
  taskId: "daily_feed_3",
  name: "喂食 3 次",
  progress: 2,
  target: 3,
  completed: false,
  rewards: {
    coins: 50,
    exp: 10
  },
  date: "2024-01-14",
  createdAt: 1704067200000,
  completedAt: null
}
```

### 设计说明

- 按日期分区，每日 0 点刷新
- `date` 字段：用于判断任务是否过期
- 任务完成后立即发放奖励

---

## 🔄 数据迁移方案

### V1.0 → V1.5 迁移（单宠物 → 多宠物）

#### 迁移步骤

**1. 创建 users 表**
```javascript
// 为每个现有用户创建 users 记录
for (let pet of existingPets) {
  await db.collection('users').add({
    data: {
      openid: pet.openid,
      nickname: null,
      avatarUrl: null,
      level: 1,
      exp: 0,
      coins: 100,  // 初始赠送
      diamonds: 0,
      activePetId: pet._id,
      unlockedSlots: [0],
      maxSlots: 3,
      totalPets: 1,
      totalActions: 0,
      createdAt: pet.createdAt,
      lastLoginAt: Date.now(),
      version: 0
    }
  })
}
```

**2. 改造 pets 表**
```javascript
// 为现有宠物添加新字段
for (let pet of existingPets) {
  await db.collection('pets').doc(pet._id).update({
    data: {
      slotIndex: 0,           // 默认槽位 0
      petType: 'cat',         // 默认类型
      health: 100,
      cleanliness: 100,
      totalFeedCount: 0,
      totalPlayCount: 0,
      totalSleepCount: 0,
      totalAliveTime: Date.now() - pet.createdAt,
      equippedItems: [],
      skinId: null
    }
  })
}
```

**3. 更新索引**
```javascript
// 删除 openid 唯一索引
// 添加 openid 普通索引
// 添加 (openid, slotIndex) 复合唯一索引
```

#### 回滚方案

如果迁移失败，可以：
1. 删除 users 表
2. 删除 pets 表中新增的字段
3. 恢复 openid 唯一索引

---

## 🎯 宠物种类配置

### 差异化设计

```javascript
const PET_CONFIG = {
  cat: {
    name: '猫咪',
    color: '#FFB6C1',      // 粉色
    size: { baby: 60, adult: 80, master: 100 },
    decayRate: {
      hunger: 0.8,         // 更独立，饿得慢
      mood: 1.2,           // 更敏感，心情降得快
      energy: 1.0
    },
    evolutionTime: {
      adult: 20 * 60 * 60 * 1000,   // 20小时
      master: 24 * 60 * 60 * 1000
    },
    personality: '独立、敏感、优雅'
  },
  
  dog: {
    name: '小狗',
    color: '#87CEEB',      // 天蓝色
    size: { baby: 60, adult: 80, master: 100 },
    decayRate: {
      hunger: 1.2,         // 更依赖，饿得快
      mood: 0.8,           // 更乐观，心情稳定
      energy: 1.0
    },
    evolutionTime: {
      adult: 24 * 60 * 60 * 1000,
      master: 30 * 60 * 60 * 1000
    },
    personality: '忠诚、活泼、依赖'
  },
  
  rabbit: {
    name: '兔子',
    color: '#FFD700',      // 金色
    size: { baby: 60, adult: 80, master: 100 },
    decayRate: {
      hunger: 1.0,
      mood: 1.0,
      energy: 0.7          // 更有活力，精力降得慢
    },
    evolutionTime: {
      adult: 18 * 60 * 60 * 1000,   // 最快进化
      master: 20 * 60 * 60 * 1000
    },
    personality: '温顺、活力、可爱'
  }
}
```

### 使用方式

```javascript
// 时间衰减时应用差异化
function settle(pet, now) {
  const config = PET_CONFIG[pet.petType]
  const delta = (now - pet.lastUpdate) / 60000
  
  pet.hunger -= delta * 1 * config.decayRate.hunger
  pet.mood -= delta * 0.5 * config.decayRate.mood
  pet.energy -= delta * 0.3 * config.decayRate.energy
  
  return pet
}

// 进化判定时应用差异化
function checkEvolution(pet, now) {
  const config = PET_CONFIG[pet.petType]
  const age = now - pet.createdAt
  
  if (pet.stage === 'baby' && age >= config.evolutionTime.adult) {
    pet.stage = 'adult'
  }
  
  if (pet.stage === 'adult' && goodDuration >= config.evolutionTime.master) {
    pet.stage = 'master'
  }
  
  return pet
}
```

---
## ✨ 设计优势

### 1. 可扩展性强

**表职责清晰**
- users 表：用户级别数据
- pets 表：宠物状态数据
- items 表：物品模板（静态）
- user_items 表：用户背包（动态）

**易于新增功能**
- 新增商城：items、user_items、transactions 表已就绪
- 新增成就：achievements、user_achievements 表独立
- 新增社交：只需新增 friends、gifts 表，不影响现有结构

### 2. 性能优化

**合理的数据冗余**
- users.activePetId：避免频繁查询 pets 表
- users.totalPets：避免 count 查询
- transactions 记录余额快照：便于对账

**完善的索引设计**
- 所有查询都有对应索引
- 复合索引覆盖常用查询
- 避免全表扫描

### 3. 数据安全

**完整的流水记录**
- transactions 表记录所有货币和物品变动
- 只增不改，保证数据完整性
- 支持追溯和对账

**并发控制**
- version 字段实现乐观锁
- 防止数据冲突
- 支持重试机制

### 4. 易于维护

**静态数据和动态数据分离**
- items、achievements：静态配置，由管理员维护
- user_items、user_achievements：动态数据，由用户操作产生

**清晰的表关系**
- 一对多关系明确
- 外键关联清晰
- 便于理解和维护

---

## ⚠️ 注意事项

### 1. 数据一致性

**用户创建宠物时**
```javascript
// 必须同时更新 users 表和 pets 表
await db.runTransaction(async transaction => {
  // 1. 创建宠物
  const petId = await transaction.collection('pets').add(...)
  
  // 2. 更新用户信息
  await transaction.collection('users').doc(userId).update({
    totalPets: _.inc(1),
    activePetId: petId  // 如果是第一只
  })
})
```

**购买物品时**
```javascript
// 必须同时更新 users、user_items、transactions 表
await db.runTransaction(async transaction => {
  // 1. 扣除货币
  await transaction.collection('users').doc(userId).update({
    coins: _.inc(-price)
  })
  
  // 2. 添加物品
  await transaction.collection('user_items').add(...)
  
  // 3. 记录交易
  await transaction.collection('transactions').add(...)
})
```

### 2. 索引维护

**定期检查索引效率**
- 使用云数据库的性能分析工具
- 监控慢查询
- 根据实际使用情况调整索引

**避免过多索引**
- 索引会占用存储空间
- 写入时需要更新索引
- 只为常用查询创建索引

### 3. 数据清理

**定期清理过期数据**
- daily_tasks：清理 7 天前的任务
- transactions：归档 3 个月前的交易记录
- 死亡宠物：可选择性归档

### 4. 数据备份

**关键表定期备份**
- users：用户数据
- pets：宠物数据
- transactions：交易记录

**备份策略**
- 每日增量备份
- 每周全量备份
- 保留至少 30 天的备份

---

## 📊 数据量估算

### 用户规模假设

- 日活用户（DAU）：10,000
- 月活用户（MAU）：50,000
- 总注册用户：200,000

### 表数据量估算

| 表名 | 单条记录大小 | 记录数 | 总大小 | 说明 |
|------|-------------|--------|--------|------|
| users | ~500 字节 | 200,000 | ~100 MB | 一个用户一条记录 |
| pets | ~800 字节 | 400,000 | ~320 MB | 平均每用户 2 只宠物 |
| items | ~600 字节 | 100 | ~60 KB | 静态数据，数量有限 |
| user_items | ~300 字节 | 2,000,000 | ~600 MB | 平均每用户 10 个物品 |
| transactions | ~400 字节 | 5,000,000 | ~2 GB | 平均每用户 25 条交易 |
| achievements | ~500 字节 | 50 | ~25 KB | 静态数据 |
| user_achievements | ~300 字节 | 1,000,000 | ~300 MB | 平均每用户 5 个成就 |
| daily_tasks | ~300 字节 | 300,000 | ~90 MB | 每日活跃用户 × 3 个任务 |

**总计**：约 3.4 GB

### 性能考虑

- 微信云数据库支持 TB 级存储
- 单表百万级数据查询性能良好
- 建议按月分表存储 transactions（如果数据量过大）

---

## 🚀 实施建议

### 阶段 1：V1.5 多宠物系统（优先级：高）

**时间估算**：5-7 天

**任务清单**：
1. 创建 users 表（1 天）
2. 改造 pets 表（1 天）
3. 编写数据迁移脚本（1 天）
4. 云函数开发（2 天）
5. 前端页面开发（2 天）
6. 测试和优化（1 天）

### 阶段 2：V2.0 物品与商城（优先级：中）

**时间估算**：7-10 天

**任务清单**：
1. 创建 items、user_items、transactions 表（1 天）
2. 配置物品数据（1 天）
3. 云函数开发（3 天）
4. 前端页面开发（3 天）
5. 测试和优化（2 天）

### 阶段 3：V2.5+ 成就与任务（优先级：低）

**时间估算**：5-7 天

**任务清单**：
1. 创建 achievements、user_achievements、daily_tasks 表（1 天）
2. 配置成就和任务数据（1 天）
3. 云函数开发（2 天）
4. 前端页面开发（2 天）
5. 测试和优化（1 天）

---

## 📝 总结

### 核心设计思想

1. **职责单一**：每个表只负责一类数据
2. **关系清晰**：表之间的关系明确，易于理解
3. **易于扩展**：新增功能不影响现有结构
4. **性能优先**：合理使用索引和冗余
5. **数据安全**：完整的流水记录和并发控制

### 适用场景

- ✅ 多宠物养成系统
- ✅ 物品和商城系统
- ✅ 成就和任务系统
- ✅ 货币和交易系统
- ✅ 未来的社交、装备等扩展

### 不适用场景

- ❌ 大规模 PVP 战斗（需要实时对战服务器）
- ❌ 复杂的公会系统（需要更多社交表）
- ❌ 实时排行榜（需要缓存层）

### 后续优化方向

1. **引入缓存层**：Redis 缓存热点数据
2. **读写分离**：主从数据库架构
3. **分表分库**：按用户 ID 哈希分表
4. **数据归档**：历史数据定期归档

---

## 📚 参考资料

- [微信小程序云开发文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/getting-started.html)
- [云数据库使用指南](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/database.html)
- [数据库索引最佳实践](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/database/index.html)

---

**文档版本**：v2.0  
**创建日期**：2024-01-14  
**最后更新**：2024-01-14  
**维护者**：开发团队

---

**变更记录**：
- v2.0 (2024-01-14)：完整的数据库架构设计，包含 8 张表的详细设计
- v1.5 (规划中)：多宠物系统数据库改造
- v1.0 (当前)：单宠物系统，仅 pets 表
